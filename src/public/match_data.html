<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Data Match</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #fdfaf6;
      color: #2c2c2c;
      margin: 20px;
    }

    h2 {
      color: #a51916;
    }

    form {
      background-color: white;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    label {
      display: block;
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin-top: 5px;
      padding: 6px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #a51916;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #831414;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #a51916;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f5f5f5;
    }
  </style>
</head>

<body>
  <h2>Upload Files for Company Data Matching</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Speaker File (required): <input type="file" name="speaker" required /></label>
    <label>Contact File (optional): <input type="file" name="contact" /></label>
    <label>Account File (optional): <input type="file" name="account" /></label>
    <label>Address File (optional): <input type="file" name="address" /></label>
    <label>LinkedIn File (optional): <input type="file" name="linkedin" /></label>
    <button type="submit">Submit</button>
    <button id="downloadMatchedBtn" type="button" disabled>Download Matched Excel</button>
    <button id="downloadUnmatchedBtn" type="button" disabled>Download Unmatched Excel</button>
  </form>

  <table id="resultTable" style="display: none;">
    <thead id="resultHeaders"></thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    let cachedFormData = null;

    const form = document.getElementById("uploadForm");
    const matchedBtn = document.getElementById("downloadMatchedBtn");
    const unmatchedBtn = document.getElementById("downloadUnmatchedBtn");

    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      const formData = new FormData(this);
      cachedFormData = formData;

      const response = await fetch("/match_data", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        alert("Error processing match data.");
        return;
      }

      const { matched, unmatched } = await response.json();
      if (!matched || matched.length === 0) {
        alert("No matched results found.");
        return;
      }

      matchedBtn.disabled = false;
      unmatchedBtn.disabled = unmatched && unmatched.length === 0;

      const table = document.getElementById("resultTable");
      const headers = document.getElementById("resultHeaders");
      const body = document.getElementById("resultBody");

      table.style.display = "table";
      headers.innerHTML = "";
      body.innerHTML = "";

      const columns = Array.from(
        new Set(matched.flatMap(row => Object.keys(row)))
      );

      const headerRow = document.createElement("tr");
      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });
      headers.appendChild(headerRow);

      matched.forEach(row => {
        const tr = document.createElement("tr");
        columns.forEach(col => {
          const td = document.createElement("td");
          td.textContent = row[col] !== undefined && row[col] !== null ? row[col] : '';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    });

    matchedBtn.addEventListener("click", async function () {
      if (!cachedFormData) {
        alert("Submit the form before downloading.");
        return;
      }

      const response = await fetch("/match_data", {
        method: "POST",
        body: cachedFormData,
        headers: {
          "Accept": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        }
      });

      if (!response.ok) {
        alert("Failed to download matched Excel.");
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "matched_data.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    });

    unmatchedBtn.addEventListener("click", async function () {
      const response = await fetch("/download_unmatched");

      if (!response.ok) {
        alert("Failed to download unmatched Excel.");
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "unmatched_data.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
