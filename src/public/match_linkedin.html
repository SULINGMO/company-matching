<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LinkedIn Company Matching</title>
    <style>
      :root {
        --aibp-red: #a51916;
        --aibp-cream: #fdfaf6;
        --aibp-dark: #2c2c2c;
        --aibp-light-gray: #f5f5f5;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #fdfaf6;
        color: #2c2c2c;
        margin: 20px;
      }
      h2 {
        color: #a51916;
      }
      form {
        background-color: white;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 10px;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        margin-bottom: 10px;
      }
      input[type="file"] {
        margin-top: 5px;
        padding: 6px;
      }
      button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #a51916;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background-color: #831414;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
      }
      th,
      td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #a51916;
        color: white;
      }
      tr:nth-child(even) {
        background-color: #f5f5f5;
      }

      .navbar {
        background-color: var(--aibp-red);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        color: white;
        font-weight: bold;
        font-size: 18px;
      }

      .navbar-links a {
        color: white;
        text-decoration: none;
        margin-left: 20px;
        font-weight: 500;
        transition: color 0.2s ease;
      }

      .navbar-links a:hover {
        color: #ffd1d1; /* lighter shade on hover */
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <div class="navbar-brand" >AIBP Match Dashboard</div>
      <div class="navbar-links">
        <a href="/">Compare Name</a>
        <a href="/match">Match Data</a>
        <a href="/compare-linkedin">Compare Linkedin Name</a>
        <a href="/match-linkedin">Match Linkedin Name</a>
        <a href="/alias-manager">Alias Manager</a>
      </div>
    </nav>
    <h2>Upload LinkedIn File to Match Against Company Data</h2>

    <form id="uploadForm" enctype="multipart/form-data">
      <label
        >LinkedIn File (required): <input type="file" name="linkedin" required
      /></label>
      <label
        >Contact File (optional): <input type="file" name="contact"
      /></label>
      <label
        >Address File (optional): <input type="file" name="address"
      /></label>
      <button type="submit">Submit</button>
      <button id="downloadMatchedBtn" type="button" disabled>
        Download Matched
      </button>
      <button id="downloadUnmatchedBtn" type="button" disabled>
        Download Unmatched
      </button>
    </form>

    <table id="resultTable" style="display: none">
      <thead id="resultHeaders"></thead>
      <tbody id="resultBody"></tbody>
    </table>

    <script>
      let cachedFormData = null;

      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const formData = new FormData(this);
          cachedFormData = formData;

          const response = await fetch("/match_linkedin_data", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            alert("Error processing LinkedIn matching.");
            return;
          }

          const { matched, unmatched } = await response.json();

          const table = document.getElementById("resultTable");
          const headers = document.getElementById("resultHeaders");
          const body = document.getElementById("resultBody");
          const matchedBtn = document.getElementById("downloadMatchedBtn");
          const unmatchedBtn = document.getElementById("downloadUnmatchedBtn");

          matchedBtn.disabled = false;
          unmatchedBtn.disabled = !unmatched || unmatched.length === 0;

          table.style.display = "table";
          headers.innerHTML = "";
          body.innerHTML = "";

          const columns = Array.from(
            new Set(matched.flatMap((row) => Object.keys(row)))
          );

          const headerRow = document.createElement("tr");
          columns.forEach((col) => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
          });
          headers.appendChild(headerRow);

          matched.forEach((row) => {
            const tr = document.createElement("tr");
            columns.forEach((col) => {
              const td = document.createElement("td");
              td.textContent =
                row[col] !== undefined && row[col] !== null ? row[col] : "";
              tr.appendChild(td);
            });
            body.appendChild(tr);
          });
        });

      document
        .getElementById("downloadMatchedBtn")
        .addEventListener("click", async function () {
          if (!cachedFormData) {
            alert("Submit the form before downloading.");
            return;
          }

          const response = await fetch("/match_linkedin_data", {
            method: "POST",
            body: cachedFormData,
            headers: {
              Accept:
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            },
          });

          if (!response.ok) {
            alert("Failed to download matched Excel.");
            return;
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "linkedin_matched_data.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        });

      document
        .getElementById("downloadUnmatchedBtn")
        .addEventListener("click", async function () {
          const response = await fetch("/download_linkedin_unmatched");

          if (!response.ok) {
            alert("Failed to download unmatched Excel.");
            return;
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "linkedin_unmatched_data.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        });
    </script>
  </body>
</html>
