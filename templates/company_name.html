<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Name Matching</title>
  <style>
    :root {
      --aibp-red: #a51916;
      --aibp-cream: #fdfaf6;
      --aibp-dark: #2c2c2c;
      --aibp-light-gray: #f5f5f5;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--aibp-cream);
      color: var(--aibp-dark);
      margin: 20px;
    }

    h2 {
      color: var(--aibp-red);
    }

    form {
      background-color: white;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }


    .manual-added {
    background-color: #eaf4ea !important;
    }

    label {
      display: block;
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin-top: 5px;
      padding: 6px;
    }

    button[type="submit"] {
      background-color: var(--aibp-red);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    button[type="submit"]:hover {
      background-color: #831414;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: var(--aibp-red);
      color: white;
    }

    tr:nth-child(even) {
      background-color: var(--aibp-light-gray);
    }

    .confirmed-row {
      background-color: #eaf4ea !important;
    }

    .highlight-100 {
      background-color: #fffbe6 !important;
    }

    .confirm-btn, .unconfirm-btn {
      margin-top: 6px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
    }

    .confirm-btn {
      background-color: var(--aibp-red);
      color: white;
    }

    .confirm-btn:hover {
      background-color: #831414;
    }

    .unconfirm-btn {
      background-color: #666;
      color: white;
    }

    .unconfirm-btn:hover {
      background-color: #444;
    }

    input[type="checkbox"] {
      margin-right: 6px;
    }

    input[type="checkbox"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button:disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
    }


  </style>
</head>
<body>
  <h2>Upload Company Lists</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Speaker List: <input type="file" name="speaker" required></label>
    <label>Account List: <input type="file" name="account"></label>
    <label>Contact List: <input type="file" name="contact"></label>
    <label>Address List: <input type="file" name="address"></label>
    <label>LinkedIn List: <input type="file" name="linkedin"></label>
    <button type="submit">Upload</button>
  </form>

  <table id="resultTable" style="display: none;">
    <thead>
      <tr id="resultTableHeaders"></tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <script>
   document.getElementById("uploadForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  const formData = new FormData(this);

  const form = this;
  const availableColumns = [];

  if (form.speaker.files.length > 0) availableColumns.push('speaker');
  if (form.account.files.length > 0) availableColumns.push('account');
  if (form.contact.files.length > 0) availableColumns.push('contact');
  if (form.address.files.length > 0) availableColumns.push('address');
  if (form.linkedin.files.length > 0) availableColumns.push('linkedin');

  console.log('Available columns:', availableColumns);


      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const results = await response.json();
        updateTableHeaders(availableColumns);
        displayResults(results, availableColumns);
      } else {
        alert('Error uploading files');
      }
    });

  function updateTableHeaders(availableColumns) {
  const headers = document.querySelector("#resultTable thead tr");
  headers.innerHTML = "";  // Clear old headers

  headers.innerHTML += `<th>Speaker Company</th>`; // ✅

  if (availableColumns.includes('account')) {
    headers.innerHTML += `<th>Matched Account</th><th>Account Similarity</th>`;
  }

  if (availableColumns.includes('contact')) {
    headers.innerHTML += `<th>Matched Contact</th><th>Contact Similarity</th>`;
  }

  if (availableColumns.includes('address')) {
    headers.innerHTML += `<th>Matched Address</th><th>Address Similarity</th>`;
  }

  if (availableColumns.includes('linkedin')) {
    headers.innerHTML += `<th>Matched LinkedIn</th><th>LinkedIn Similarity</th>`;
  }

  headers.innerHTML += `<th>Actions</th>`;
}

  function displayResults(results, availableColumns) {
  const resultsBody = document.getElementById("resultsBody");
  resultsBody.innerHTML = '';

  results.forEach(result => {
    const row = document.createElement("tr");
    let rowData = `<td>${result.speaker || 'None'}</td>`;

    function generateCellContent(item, type, speaker) {
      if (!item) return { nameCell: '<td></td>', similarityCell: '<td></td>' };

      let highlightClass = "";

      if (item.similarity === 1) {
        highlightClass = "manual-added"; // Green
      } else if (item.fromAliasMatch) {
        highlightClass = "highlight-100"; // Yellow
      }

      return {
        nameCell: `
          <td style="vertical-align: top;">
            <div class="${highlightClass}" style="padding: 6px; margin-bottom: 4px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; gap: 6px;">
              <input type="checkbox"
                     class="match-checkbox"
                     data-type="${type}"
                     data-speaker="${speaker}"
                     data-name="${item.name}">
              ${item.name}
            </div>
          </td>
        `,
        similarityCell: `
          <td style="vertical-align: top;">
            <div class="${highlightClass}" style="padding: 6px; margin-bottom: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
              ${(item.similarity * 100).toFixed(0)}%
            </div>
          </td>
        `
      };
    }


    if (availableColumns.includes('account')) {
  const acc = result.matched_account?.[0];
  const { nameCell, similarityCell } = generateCellContent(acc, 'account', result.speaker);
  rowData += nameCell + similarityCell;
}

if (availableColumns.includes('contact')) {
  const con = result.matched_contact?.[0];
  const { nameCell, similarityCell } = generateCellContent(con, 'contact', result.speaker);
  rowData += nameCell + similarityCell;
}

if (availableColumns.includes('address')) {
  const addr = result.matched_address?.[0];
  const { nameCell, similarityCell } = generateCellContent(addr, 'address', result.speaker);
  rowData += nameCell + similarityCell;
}

if (availableColumns.includes('linkedin')) {
  if (result.matched_linkedin && result.matched_linkedin.length > 0) {
    let nameCell = '<td style="vertical-align: top;">';
    let similarityCell = '<td style="vertical-align: top;">';
    const seenNames = new Set();

    result.matched_linkedin.forEach((item, index) => {
      if (!seenNames.has(item.name)) {
        seenNames.add(item.name);

        let highlightClass = "";
        if (item.similarity === 1) {
          highlightClass = "manual-added";
        } else if (item.fromAliasMatch) {
          highlightClass = "highlight-100";
        }

        nameCell += `
          <div class="${highlightClass}" style="padding: 6px; margin-bottom: 4px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; gap: 6px;">
            <input type="checkbox"
                   class="match-checkbox"
                   data-type="linkedin"
                   data-speaker="${result.speaker}"
                   data-name="${item.name}">
            ${item.name}
          </div>
        `;

        similarityCell += `
          <div class="${highlightClass}" style="padding: 6px; margin-bottom: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
            ${(item.similarity * 100).toFixed(0)}%
          </div>
        `;
      }
    });

    nameCell += '</td>';
    similarityCell += '</td>';

    rowData += nameCell + similarityCell;
  } else {
    rowData += '<td></td><td></td>';

  }
}

    rowData += `<td>`;



    rowData += `
      <button class="confirm-btn" onclick="confirmSelectedMatches('${result.speaker}')">Confirm</button>
      <button class="unconfirm-btn" onclick="unconfirmMatch('${result.speaker}')">Unconfirm</button>
    </td>`;

    row.innerHTML = rowData;
    resultsBody.appendChild(row);
  });

  document.getElementById("resultTable").style.display = 'table';
}



    async function confirmMatch(result) {
      const response = await fetch('/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([result])
      });

      if (response.ok) {
        alert('Match confirmed!');
      } else {
        alert('Error confirming match');
      }
    }

   async function confirmSelectedMatches(speaker) {
  const checkboxes = document.querySelectorAll(`.match-checkbox[data-speaker="${speaker}"]:checked`);
  const selectedTypes = Array.from(checkboxes).map(cb => cb.getAttribute('data-type'));

  if (selectedTypes.length === 0) {
    alert('Please select at least one match to confirm.');
    return;
  }

  const row = Array.from(document.querySelectorAll("#resultsBody tr")).find(r =>
    r.firstChild?.textContent?.trim() === speaker
  );

  const typeToIndexOffset = {
    'account': 1,
    'contact': 3,
    'address': 5,
    'linkedin': 7
  };

  const payload = {
    speaker: speaker,
    fields: selectedTypes
  };

  selectedTypes.forEach(type => {
    if (type === 'linkedin') {
      const linkedinCheckboxes = document.querySelectorAll(`.match-checkbox[data-speaker="${speaker}"][data-type="linkedin"]:checked`);
      payload[`matched_linkedin`] = Array.from(linkedinCheckboxes).map(cb => cb.getAttribute('data-name'));
    } else {
      const colIndex = typeToIndexOffset[type];
      if (colIndex !== undefined && row?.children[colIndex]) {
        const matchedName = row.children[colIndex].textContent?.trim();
        if (matchedName && matchedName !== '') {
          payload[`matched_${type}`] = matchedName;
        }
      }
    }
  });

  console.log("DEBUG Payload being sent:", payload);

  const response = await fetch('/confirm', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (response.ok) {
    alert('Selected matches confirmed!');

    // ✅ After confirm, immediately update class to yellow
    checkboxes.forEach(cb => {
      const div = cb.closest('div');
      if (div) {
        div.classList.remove('manual-added');
        div.classList.add('highlight-100');
      }
    });

  } else {
    alert('Error confirming selected matches.');
  }
}




async function unconfirmMatch(speaker) {
  const checkboxes = document.querySelectorAll(`.match-checkbox[data-speaker="${speaker}"]:checked`);
  const selectedTypes = Array.from(checkboxes).map(cb => cb.getAttribute('data-type'));

  if (selectedTypes.length === 0) {
    alert('Please select at least one match to unconfirm.');
    return;
  }

  const row = Array.from(document.querySelectorAll("#resultsBody tr")).find(r =>
    r.firstChild?.textContent?.trim() === speaker
  );

  const typeToIndexOffset = {
    'account': 1,
    'contact': 3,
    'address': 5,
    'linkedin': 7
  };

  const payload = {
    speaker: speaker,
    fields: selectedTypes
  };

  selectedTypes.forEach(type => {
    if (type === 'linkedin') {
      const linkedinCheckboxes = document.querySelectorAll(`.match-checkbox[data-speaker="${speaker}"][data-type="linkedin"]:checked`);
      payload[`matched_linkedin`] = Array.from(linkedinCheckboxes).map(cb => cb.getAttribute('data-name'));
    } else {
      const colIndex = typeToIndexOffset[type];
      if (colIndex !== undefined && row?.children[colIndex]) {
        const matchedName = row.children[colIndex].textContent?.trim();
        if (matchedName && matchedName !== '') {
          payload[`matched_${type}`] = matchedName;
        }
      }
    }
  });

  console.log("DEBUG Payload being sent for unconfirm:", payload);

  const response = await fetch('/unconfirm', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (response.ok) {
    alert('Selected matches unconfirmed!');

    // ✅ After unconfirm, immediately remove yellow color
    checkboxes.forEach(cb => {
      const div = cb.closest('div');
      if (div) {
        div.classList.remove('highlight-100');
        div.classList.remove('manual-added');
      }
    });

  } else {
    alert('Error unconfirming selected matches.');
  }
}







  </script>
</body>
</html>