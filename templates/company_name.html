<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Name Matching</title>
  <style>
    :root {
      --aibp-red: #a51916;
      --aibp-cream: #fdfaf6;
      --aibp-dark: #2c2c2c;
      --aibp-light-gray: #f5f5f5;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--aibp-cream);
      color: var(--aibp-dark);
      margin: 20px;
    }

    h2 {
      color: var(--aibp-red);
    }

    form {
      background-color: white;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    label {
      display: block;
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin-top: 5px;
      padding: 6px;
    }

    button[type="submit"] {
      background-color: var(--aibp-red);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    button[type="submit"]:hover {
      background-color: #831414;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: var(--aibp-red);
      color: white;
    }

    tr:nth-child(even) {
      background-color: var(--aibp-light-gray);
    }

    .confirmed-row {
      background-color: #eaf4ea !important;
    }

    .highlight-100 {
      background-color: #fffbe6 !important;
    }

    .confirm-btn, .unconfirm-btn {
      margin-top: 6px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
    }

    .confirm-btn {
      background-color: var(--aibp-red);
      color: white;
    }

    .confirm-btn:hover {
      background-color: #831414;
    }

    .unconfirm-btn {
      background-color: #666;
      color: white;
    }

    .unconfirm-btn:hover {
      background-color: #444;
    }

    input[type="checkbox"] {
      margin-right: 6px;
    }

    input[type="checkbox"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button:disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>Upload Company Lists</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Speaker List: <input type="file" name="speaker" required></label>
    <label>Account List: <input type="file" name="account"></label>
    <label>Contact List: <input type="file" name="contact"></label>
    <label>Address List: <input type="file" name="address"></label>
    <label>LinkedIn List: <input type="file" name="linkedin"></label>
    <button type="submit">Upload</button>
  </form>

  <table id="resultTable" style="display: none;">
    <thead>
      <tr id="resultTableHeaders"></tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <script>
   document.getElementById("uploadForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  const formData = new FormData(this);

  const form = this;
  const availableColumns = [];

  if (form.speaker.files.length > 0) availableColumns.push('speaker');
  if (form.account.files.length > 0) availableColumns.push('account');
  if (form.contact.files.length > 0) availableColumns.push('contact');
  if (form.address.files.length > 0) availableColumns.push('address');
  if (form.linkedin.files.length > 0) availableColumns.push('linkedin');

  console.log('Available columns:', availableColumns);


      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const results = await response.json();
        updateTableHeaders(availableColumns);
        displayResults(results, availableColumns);
      } else {
        alert('Error uploading files');
      }
    });

  function updateTableHeaders(availableColumns) {
  const headers = document.querySelector("#resultTable thead tr");
  headers.innerHTML = "";  // Clear old headers

  headers.innerHTML += `<th>Speaker Company</th>`; // âœ…

  if (availableColumns.includes('account')) {
    headers.innerHTML += `<th>Matched Account</th><th>Account Similarity</th>`;
  }

  if (availableColumns.includes('contact')) {
    headers.innerHTML += `<th>Matched Contact</th><th>Contact Similarity</th>`;
  }

  if (availableColumns.includes('address')) {
    headers.innerHTML += `<th>Matched Address</th><th>Address Similarity</th>`;
  }

  if (availableColumns.includes('linkedin')) {
    headers.innerHTML += `<th>Matched LinkedIn</th><th>LinkedIn Similarity</th>`;
  }

  headers.innerHTML += `<th>Actions</th>`;
}

  function displayResults(results, availableColumns) {
  const resultsBody = document.getElementById("resultsBody");
  resultsBody.innerHTML = '';

  results.forEach(result => {
    const row = document.createElement("tr");

   let rowData = `<td>${result.speaker || 'None'}</td>`;

    if (availableColumns.includes('account')) {
      const acc = result.matched_account;
      rowData += `
        <td>${acc[0]?.name || 'None'}</td>
        <td>${acc[0]?.similarity != null ? acc[0].similarity * 100+ '%' : 'N/A'}</td>
      `;
    }

    if (availableColumns.includes('contact')) {
      const con = result.matched_contact;
      rowData += `
        <td>${con[0]?.name || 'None'}</td>
        <td>${con[0]?.similarity != null ? con[0].similarity * 100+ '%' : 'N/A'}</td>
      `;
    }

    if (availableColumns.includes('address')) {
      const addr = result.matched_address;
      rowData += `
        <td>${addr[0]?.name || 'None'}</td>
        <td>${addr[0]?.similarity != null ? addr[0].similarity * 100+ '%' : 'N/A'}</td>
      `;
    }

    if (availableColumns.includes('linkedin')) {
      const li = result.matched_linkedin;
      rowData += `
        <td>${li[0]?.name || 'None'}</td>
        <td>${li[0]?.similarity != null ? li[0].similarity * 100 + '%' : 'N/A'}</td>
      `;
    }

    rowData += `<td>`;

if (availableColumns.includes('account') && result.matched_account?.[0]) {
  rowData += `<label><input type="checkbox" class="match-checkbox" data-type="account" data-speaker="${result.speaker}"> Account</label><br>`;
}

if (availableColumns.includes('contact') && result.matched_contact?.[0]) {
  rowData += `<label><input type="checkbox" class="match-checkbox" data-type="contact" data-speaker="${result.speaker}"> Contact</label><br>`;
}

if (availableColumns.includes('address') && result.matched_address?.[0]) {
  rowData += `<label><input type="checkbox" class="match-checkbox" data-type="address" data-speaker="${result.speaker}"> Address</label><br>`;
}

if (availableColumns.includes('linkedin') && result.matched_linkedin?.[0]) {
  rowData += `<label><input type="checkbox" class="match-checkbox" data-type="linkedin" data-speaker="${result.speaker}"> LinkedIn</label><br>`;
}

rowData += `
  <button class="confirm-btn" onclick="confirmSelectedMatches('${result.speaker}')">Confirm</button>
  <button class="unconfirm-btn" onclick="unconfirmMatch('${result.speaker}')">Unconfirm</button>
</td>`;


    row.innerHTML = rowData;
    resultsBody.appendChild(row);
  });

  document.getElementById("resultTable").style.display = 'table';
}


    async function confirmMatch(result) {
      const response = await fetch('/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([result])
      });

      if (response.ok) {
        alert('Match confirmed!');
      } else {
        alert('Error confirming match');
      }
    }

    async function unconfirmMatch(speaker) {
      const field = prompt('Enter field to unconfirm (account, contact, linkedin, address, or leave blank for all):');
      const response = await fetch('/unconfirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ speaker, field })
      });

      if (response.ok) {
        alert('Match unconfirmed!');
      } else {
        alert('Error unconfirming match');
      }
    }
    async function confirmSelectedMatches(speaker) {
  const checkboxes = document.querySelectorAll(`.match-checkbox[data-speaker="${speaker}"]:checked`);
  const selectedTypes = Array.from(checkboxes).map(cb => cb.getAttribute('data-type'));

  if (selectedTypes.length === 0) {
    alert('Please select at least one match to confirm.');
    return;
  }

  const response = await fetch('/confirm', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ speaker, fields: selectedTypes })
  });

  if (response.ok) {
    alert('Selected matches confirmed!');
  } else {
    alert('Error confirming selected matches.');
  }
}

  </script>
</body>
</html>